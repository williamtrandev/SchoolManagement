<div class="row mb-2">
	<div class="col-12 d-flex align-items-center justify-content-between">
	
		<select class="form-select w-auto" id="year">
			{{#each years}}
				{{#if @last }}
					<option value="{{_id}}" selected>{{startYear}}-{{endYear}}</option>
				{{else}}
					<option value="{{_id}}">{{startYear}}-{{endYear}}</option>
				{{/if}}
			{{/each}}
		</select>
		<div class="">
			<div class="btn-group">
				<button class="btn btn-primary me-3 px-4" data-toggle="modal" data-target="#addByFile">Thêm bằng file</button>
			</div>
			<div class="btn-group">
				<button class="btn bg-white border px-4" data-toggle="modal" data-target="#addStudent">Thêm thủ công</button>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-2">
		<p class="mt-4"></p>
		{{#each grades}}
			<p class="w-100 dropdown-toggle" type="button" data-toggle="collapse" data-target="#grade{{@key}}" aria-expanded="false" aria-controls="grade{{@key}}">
				Khối {{@key}}
			</p>
			<div class="collapse" id="grade{{@key}}">
				<ul>
					{{#each this}}
						<li class="grade-li my-2" style="cursor: pointer;" data-id="{{_id}}">
							Lớp {{name}}
						</li>
					{{/each}}
				</ul>
			</div>
		{{/each}}
	</div>
	<div class="bg-light text-center rounded p-4 col-10">
		<div class="table-responsive">
			<table class="table text-center align-middle table-bordered table-hover mb-0">
				<thead>
					<tr class="text-dark">
						<th scope="col">Mã học sinh</th>
						<th scope="col">Họ tên</th>
						<th scope="col">Ngày sinh</th>
						<th scope="col">Lớp</th>
						<th scope="col">Giới tính</th>
						<th scope="col">Dân tộc</th>
						<th scope="col">Chỗ ở hiện tại</th>
					</tr>
				</thead>
				<tbody id="tbody-student">
					{{#each students}}
						<tr>
							<td>{{studentId}}</td>
							<td>{{name}}</td>
							<td>{{birthday}}</td>
							<td>{{class}}</td>
							<td>{{gender}}</td>
							<td>{{ethnic}}</td>
							<td>{{address}}</td>
						</tr>
					{{/each}}
				</tbody>
			</table>
		</div>
	</div>
</div>

<div class="modal fade" id="addStudent">
    <div class="modal-dialog">
		<div class="modal-content p-2">
			<!-- Modal Header -->
			<div class="modal-header justify-content-center">
				<h4 class="modal-title">Thêm mới học sinh</h4>
			</div>
			
			<!-- Modal body -->
			<div class="modal-body">
				<form>
					<div class="form-group mb-3">
						<label style="font-weight: bold" class="mb-1" for="name">Họ tên</label>
						<input type="text" class="form-control" id="name" placeholder="Thành Trần" required>
					</div>
					<div class="form-group mb-3">
						<label style="font-weight: bold" class="mb-1" for="birthday">Ngày sinh</label>
						<input type="date" class="form-control" id="birthday" placeholder="Thành Trần" required>
					</div>
					<div class="form-group mb-3">
						<label style="font-weight: bold" class="mb-1" for="classStudent">Lớp</label>
						<select class="form-select" id="classStudent" required>
							{{#each classes}}
								<option value="{{_id}}">{{name}}</option>
							{{/each}}
						</select>
					</div>
					<div class="form-group mb-3">
						<label style="font-weight: bold" class="mb-1" for="gender">Giới tính</label>
						<select class="form-select" id="gender" required>
							<option value="1">Nam</option>
							<option value="0">Nữ</option>
						</select>
					</div>
					<div class="form-group mb-3">
						<label style="font-weight: bold" class="mb-1" for="ethnic">Dân tộc</label>
						<input type="text" class="form-control" id="ethnic" placeholder="Kinh" required>
					</div>
					<div class="form-group mb-3">
						<label style="font-weight: bold" class="mb-1" for="address">Chỗ ở hiện tại</label>
						<input type="text" class="form-control" id="address" placeholder="Đồng Tháp" required>
					</div>
					<button type="button" class="btn btn-primary btn-save-student-single">Lưu</button>
				</form>
			</div>
			
			<!-- Modal footer -->
			<div class="modal-footer">
			</div>
			
		</div>
	</div>
</div>


<div class="modal fade" id="addByFile">
    <div class="modal-dialog">
		<div class="modal-content p-2">
			<!-- Modal Header -->
			<div class="modal-header justify-content-center">
				<h4 class="modal-title">Thêm học sinh</h4>
			</div>
			
			<!-- Modal body -->
			<div class="modal-body">
				<form enctype="multipart/form-data">
					<input type="file" name="file" id="file-input" class="d-none" accept=".xlsx, .xls">
					<label for="file-input" style="cursor: pointer;" class="d-block position-relative text-white bg-primary text-center rounded m-auto p-3"><i class="fas fa-upload"></i>&nbsp;Chọn File để thêm</label>
					<p class="text-primary text-center p-2 mt-3 d-none rounded" style="background: #eff5ff;" id="file-name"></p>
				</form>
				<p class="mt-2">Tải tệp mẫu <a href="">tại đây</a></p>
			</div>
			<!-- Modal footer -->
			<div class="modal-footer">
				<button class="btn btn-primary btn-save-file">Xác nhận</button>
				<button class="btn border" data-dismiss="modal">Đóng</button>
			</div>
		</div>
	</div>
</div>



<script>
	$(function() {
		$('#file-input').change(() => {
			let name = $('#file-input')[0].files[0].name;
			$('#file-name').text(name);
			$('#file-name').removeClass('d-none');
		});
		$("#year").change(function () {
			let id = $(this).val();
			fetch(`/teacher/getGradeByYear/${id}`)
			.then(res => res.json())
			.then(data => {
				console.log(data);	
				if(data) {
					let class6 = ``;
					let class7 = ``;
					let class8 = ``;
					let class9 = ``;
					data.forEach(item => {
						if(item.grade == 6) {
							class6 += `
							<li class="grade-li my-2" style="cursor: pointer;" data-id="${item._id}">
								Lớp ${item.name}
							</li>`;
						} else if(item.grade == 7) {
							class7 += `
							<li class="grade-li my-2" style="cursor: pointer;" data-id="${item._id}">
								Lớp ${item.name}
							</li>`;
						} else if(item.grade == 8) {
							class8 += `
							<li class="grade-li my-2" style="cursor: pointer;" data-id="${item._id}">
								Lớp ${item.name}
							</li>`;
						} else {
							class9 += `
							<li class="grade-li my-2" style="cursor: pointer;" data-id="${item._id}">
								Lớp ${item.name}
							</li>`;
						}
					});
					$('#grade6 ul').empty().append(class6);
					$('#grade7 ul').empty().append(class7);	
					$('#grade8 ul').empty().append(class8);
					$('#grade9 ul').empty().append(class9);
				}
			})
			.catch(err => {
				console.log(err);
				toastr.error('Lỗi hệ thống');
			})
		})
		$(".btn-save-student-single").click(() => {
			let id = $('#classStudent').val();
			let name = $('#name').val();
			let birthday = $('#birthday').val();
			let gender = $('#gender').val();
			let ethnic = $('#ethnic').val();
			let address = $('#address').val();
			let classText = $('#classStudent :selected').text();
			if (name === '' || birthday === '' || ethnic === '' || address === '') {
				toastr.error("Vui lòng nhập đầy đủ thông tin");
			} else {
				fetch(`/teacher/addStudent/${id}`, {
					method: "POST",
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({name, birthday, gender, ethnic, address})
				})
				.then((res) => {
					if (!res.ok) {
						throw new Error(`Mã lỗi HTTP: ${res.status}`);
					}
					return res.json();
				})
				.then(data => {
					const inputDateStr = data.birthday;
					const year = inputDateStr.substr(0, 4);    // Trích xuất 4 ký tự đầu là năm
					const month = inputDateStr.substr(5, 2);   // Trích xuất 2 ký tự sau là tháng
					const day = inputDateStr.substr(8, 2);     // Trích xuất 2 ký tự sau là ngày
					const gender = data.gender ? 'Nam' : 'Nữ';
					// định dạng "DD/MM/YYYY"
					const birthday = `${day}/${month}/${year}`;
					let newTr = `<tr>
							<td>${data.studentId}</td>
							<td>${data.name}</td>
							<td>${birthday}</td>
							<td>${classText}</td>
							<td>${gender}</td>
							<td>${data.ethnic}</td>
							<td>${data.address}</td>
						</tr>`;
					toastr.success("Thêm thành công");
					$('tbody').append(newTr);
				})
				.catch(err => {
					console.log(err);
					toastr.error("Thêm không thành công");
				});
				$("#addStudent").modal("hide");
			}
			
		});
		$(".btn-save-file").click(() => {
			const file = $('#file-input')[0].files[0];
			if(file) {
				const formData = new FormData();
				formData.append('file', file);
				fetch('/teacher/addStudentByFile', {
					method: 'POST',
					body: formData,
				})
				.then(response => response.json())
				.then(data => {
					console.log(data);
				})
				.catch(error => {
					console.error(error);
				});
			}
		})
	});
	$('.grade-li').click(function () {
		$('#spinner').addClass('show');
		$('#tbody-student').empty();
		let id = $(this).data("id");
		fetch(`/teacher/class?id=${id}`)
		.then(res => res.json())
		.then(data => {
			if(data.students) {
				let tr = ``;
				data.students.forEach(student => {
					const gender = student.gender === true ? 'Nam' : 'Nữ';
					const parts = student.birthday.substring(0, 10).split('-');
					const birthday = `${parts[2]}-${parts[1]}-${parts[0]}`;
					tr += `<tr>
							<td>${student.studentId}</td>
							<td>${student.name}</td>
							<td>${birthday}</td>
							<td>${student.class}</td>
							<td>${gender}</td>
							<td>${student.ethnic}</td>
							<td>${student.address}</td>
						</tr>`;
				});
				$('#tbody-student').append(tr);
				$('#spinner').removeClass('show');
			}
		})
		.catch(error => { 
			console.log(error);
			$('#spinner').removeClass('show');
			toastr.error("Lỗi hệ thống");
		});
	})
</script>