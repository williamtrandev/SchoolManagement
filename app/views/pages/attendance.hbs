<div class="bg-light text-center rounded p-4">
	<div class="d-flex align-items-center justify-content-between mb-4">
		<h5 class="mb-0">Trạng thái: <span id="attendance"></span></h5>
		<div class="d-flex align-items-center">
			<label for="grade">Khối</label>
			<select class="form-select mx-3" id="grade" style="width: auto">
				<option value="no" selected>Chọn khối</option>
				<option value="6">6</option>
				<option value="7">7</option>
				<option value="8">8</option>
				<option value="9">9</option>
			</select>
			<label for="class">Lớp</label>
			<select class="form-select mx-3" id="class" style="width: auto">
			</select>
		</div>
		<div class="d-flex justify-content-between align-items-center">
			<div class="p-2 rounded-1 bg-success text-white me-3">Tất cả: <span id="totalStudent"></span></div>
			<div class="p-2 rounded-1 bg-info text-white me-3">Có mặt: <span id="presentStudent">0</span></div>
			<div class="p-2 rounded-1 bg-warning text-white me-3">Vắng: <span id="absentStudent">0</span></div>
		</div>
	</div>
	<div class="table-responsive">
		<table class="table text-center align-middle table-bordered table-hover mb-0" id="attendance-table">
			<thead>
				<tr class="text-dark">
					<th scope="col">STT</th>
					<th scope="col">Họ tên</th>
					<th scope="col">Ngày sinh</th>
					<th scope="col">Có mặt</th>
					<th scope="col">Vắng</th>
					<th scope="col">Vi phạm</th>
				</tr>
			</thead>
			<tbody>
				
			</tbody>
		</table>
	</div>
	<button class="btn btn-info text-white my-3 btn-save">Lưu</button>
</div>

<script>
	function handleClickAttendance(e) {
		
		// Lấy hàng (row) chứa phần tử đang được click
		let row = $(e).closest('tr');
		// Lấy tất cả các checkbox và select box trong hàng
		let checkboxesAndSelect = $('input[type="checkbox"]', row);
		// Đặt trạng thái của tất cả các phần tử trong hàng bằng với checkbox đang được click
		checkboxesAndSelect.prop('checked', false);
		$(e).prop('checked', true); 
		if($(e).hasClass('absent')) {
			row.data('absent', 1);
		} else if(row.data('restore') == 1) {
			row.data('update', 1);
		}
		let numPresent = $("input.present:checked").length;
		let numAbsent1 = $("input.absent:checked").length;
		$("#presentStudent").text(numPresent);
		$("#absentStudent").text(numAbsent1);
	}
	$(function() {
		
		$("#grade").change(function() {
			let grade = $(this).val();
			fetch(`/teacher/classes/${grade}`)
			.then(res => res.json())
			.then(data => {
				$("#class").empty();
				data.forEach(item => {
					$("#class").append(`<option value=${item._id}>${item.name}</option>`);
				});
				
				$("#class").change();

			})
			.catch(err => { console.log(err) });
		});

		$("#class").change(function() {
			const id = $(this).val();
			const currentDate = new Date();
			const day = currentDate.getDate(); // Lấy ngày (1-31)
			const month = currentDate.getMonth() + 1; // Lấy tháng (0-11) và cộng thêm 1 để đổi về (1-12)
			const year = currentDate.getFullYear(); 
			const date = `${year}-${month}-${day}`;
			fetch(`/teacher/class?id=${id}&date=${date}`)
			.then(res => res.json())
			.then(data => {
				console.log(data.isAttended);
				let stateAtten = data.isAttended ? 'Đã điểm danh' : 'Chưa điểm danh';
				$("#attendance").text(stateAtten);	
				$("#totalStudent").text(data.students.length);
				
				$("#attendance-table tbody").empty();
				let i = 1;
				let newTbody = '';

				data.students.forEach(item => {
					let parts = item.student.birthday.substring(0, 10).split("-");
					let birthday = `${parts[2]}-${parts[1]}-${parts[0]}`;
					let checkedAbsent = '';
					let checkedPresent = 'checked';
					let restore = 0;
					let absent = 0;
					console.log("absentdays: " + item.absentDays + ", date: " + date)
					if(item.absentDays.includes(date)) {
						checkedAbsent = 'checked';
						checkedPresent = '';
						restore = 1;
						absent = 1;
					}
					newTbody += 
					`<tr data-id=${item.student._id} data-class=${id} data-absent=${absent} data-restore=${restore}>
						<td>${i++}</td>
						<td>${item.student.name}</td>
						<td>${birthday}</td>
						<td><input type="checkbox" class="form-check-input present" ${checkedPresent} 
							onclick='handleClickAttendance(this)'></td>
						<td><input type="checkbox" class="form-check-input absent" ${checkedAbsent} 
							onclick='handleClickAttendance(this)'></td>
						<td>
							<select class="form-select" aria-label="Vi Phạm">
								<option value="no" selected>Không Vi Phạm</option>
								<option value="tacphong">Tác Phong</option>
								<option value="daoduc">Đạo Đức</option>
							</select>
						</td>
					</tr>`;
				});
				$("#attendance-table tbody").append(newTbody);
				let numAbsent = $("input.absent:checked").length;
				$("#absentStudent").text(numAbsent);
			})
			.catch(err => {
				console.log(err);
			});
		})

		$(".btn-save").click(async function() {
			let data = [];
			let idClass = "";
			await $("#attendance-table tbody tr").each(function() {
				const dataID = $(this).data("id");
				const dataClass = $(this).data("class");
				idClass = dataClass;
				const dataUpdate = $(this).data('update');
				const dataAbsent = $(this).data('absent');
				// Tạo đối tượng từ giá trị data
				const dataObject = {
					student: dataID,
					class: dataClass,
					absent: dataAbsent == 1,
					restore: dataUpdate !== undefined 
				};
				
				// Thêm đối tượng vào mảng dataObjects
				data.push(dataObject);
			});
			console.log(data)
			fetch(`/teacher/checkAttendance`, {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify({ data, idClass }),
			})
			.then(res => res.json())
			.then(data => {
				console.log("Success");
				toastr.success("Đã lưu dữ liệu điểm danh");
				$("#attendance").text("Đã điểm danh");
			})
			.catch(err => {
				console.log(err);
				toastr.error("Đã có lỗi xảy ra");
			})
		})
	})
</script>